name: Sync Config to Branches

on:
  push:
    branches:
      - main
    paths:
      - 'config.yaml'
      - 'docker-compose.yaml'
      - 'Dockerfile'

jobs:
  sync-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        uses: mikefarah/yq@v4.52.2

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync to all branches
        run: |
          set -e

          # Already on main, save template files
          git checkout main
          git pull origin main
          cp Dockerfile /tmp/main_Dockerfile
          cp docker-compose.yaml /tmp/main_docker_compose.yaml
          echo "Saved main files for propagation"

          # Read IP from config.yaml
          IP=$(yq '.ip' config.yaml | tr -d '"')
          echo "IP: $IP"

          # Get all cores under runner
          CORES=$(yq '.runner | keys | .[]' config.yaml)

          # ============================================
          # PHASE 1: Process all "normal" branches first
          # ============================================
          echo "=== PHASE 1: Processing normal branches ==="

          for CORE in $CORES; do
            # Read hardware limits for this core
            CPU=$(yq ".runner.$CORE.hw.cpu" config.yaml)
            MEMORY=$(yq ".runner.$CORE.hw.memory" config.yaml | tr -d '"')
            WORKERS=$(yq ".runner.$CORE.workers.normal" config.yaml)
            BRANCH="$CORE"

            echo "Processing normal branch: $BRANCH"
            echo "  CPU: $CPU, Memory: $MEMORY, Workers: $WORKERS"

            # Check if branch exists on remote
            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              echo "  Branch exists on remote, checking out..."
              git branch -D "$BRANCH" 2>/dev/null || true
              git fetch origin "$BRANCH"
              git checkout -b "$BRANCH" "origin/$BRANCH"
            else
              echo "  Branch does not exist, creating from main..."
              git checkout main
              git checkout -b "$BRANCH"
            fi

            # Copy main files (Dockerfile + docker-compose.yaml)
            cp /tmp/main_Dockerfile Dockerfile
            cp /tmp/main_docker_compose.yaml docker-compose.yaml
            echo "  Copied main files"

            # Update docker-compose.yaml with all values
            sed -i "s|cpus: \"[^\"]*\"|cpus: \"$CPU\"|" docker-compose.yaml
            sed -i "s|memory: [^ ]*|memory: $MEMORY|" docker-compose.yaml
            sed -i "s|command: \[\"[^\"]*\", \"[^\"]*\"\]|command: [\"$IP\", \"$WORKERS\"]|" docker-compose.yaml

            # Commit and push if there are changes
            git add Dockerfile docker-compose.yaml
            if ! git diff --cached --quiet; then
              git commit -m "chore: Update config (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"
              git push origin "$BRANCH"
              echo "  ✓ Updated and pushed $BRANCH"
            else
              echo "  No changes needed for $BRANCH"
            fi

            # Push branch if it was newly created
            if ! git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              git push -u origin "$BRANCH"
              echo "  ✓ Pushed new branch $BRANCH"
            fi

            git checkout main
          done

          # ============================================
          # PHASE 2: Process all derived branches
          # ============================================
          echo "=== PHASE 2: Processing derived branches ==="

          for CORE in $CORES; do
            # Read hardware limits for this core (same for all worker classes)
            CPU=$(yq ".runner.$CORE.hw.cpu" config.yaml)
            MEMORY=$(yq ".runner.$CORE.hw.memory" config.yaml | tr -d '"')

            # Get all worker classes for this core
            CLASSES=$(yq ".runner.$CORE.workers | keys | .[]" config.yaml)

            for CLASS in $CLASSES; do
              # Skip normal class (already processed in Phase 1)
              if [ "$CLASS" = "normal" ]; then
                continue
              fi

              WORKERS=$(yq ".runner.$CORE.workers.$CLASS" config.yaml)
              BRANCH="$CORE-$CLASS"

              echo "Processing derived branch: $BRANCH"
              echo "  CPU: $CPU, Memory: $MEMORY, Workers: $WORKERS"

              # Check if branch exists on remote
              if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
                echo "  Branch exists on remote, checking out..."
                git branch -D "$BRANCH" 2>/dev/null || true
                git fetch origin "$BRANCH"
                git checkout -b "$BRANCH" "origin/$BRANCH"
              else
                echo "  Branch does not exist, creating from $CORE..."
                git branch -D "$CORE" 2>/dev/null || true
                git fetch origin "$CORE"
                git checkout -b "$CORE" "origin/$CORE"
                git checkout -b "$BRANCH"
              fi

              # Copy main files (Dockerfile + docker-compose.yaml)
              cp /tmp/main_Dockerfile Dockerfile
              cp /tmp/main_docker_compose.yaml docker-compose.yaml
              echo "  Copied main files"

              # Update docker-compose.yaml with all values
              sed -i "s|cpus: \"[^\"]*\"|cpus: \"$CPU\"|" docker-compose.yaml
              sed -i "s|memory: [^ ]*|memory: $MEMORY|" docker-compose.yaml
              sed -i "s|command: \[\"[^\"]*\", \"[^\"]*\"\]|command: [\"$IP\", \"$WORKERS\"]|" docker-compose.yaml

              # Commit and push if there are changes
              git add Dockerfile docker-compose.yaml
              if ! git diff --cached --quiet; then
                git commit -m "chore: Update config (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"
                git push origin "$BRANCH"
                echo "  ✓ Updated and pushed $BRANCH"
              else
                echo "  No changes needed for $BRANCH"
              fi

              # Push branch if it was newly created
              if ! git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
                git push -u origin "$BRANCH"
                echo "  ✓ Pushed new branch $BRANCH"
              fi

              git checkout main
            done
          done

          echo "✓ Sync completed"
