name: Sync Config to Branches

on:
  push:
    branches:
      - main
    paths:
      - 'config.yaml'
      - 'docker-compose.yaml'
      - 'Dockerfile'

jobs:
  sync-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        uses: mikefarah/yq@v4.52.2

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect changed files
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "config.yaml docker-compose.yaml Dockerfile")
          echo "files: $CHANGED"
          
          echo "dockerfile=$(echo "$CHANGED" | grep -q 'Dockerfile' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "compose=$(echo "$CHANGED" | grep -q 'docker-compose.yaml' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "config=$(echo "$CHANGED" | grep -q 'config.yaml' && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Create README templates
        run: |
          cat > /tmp/readme_en.template << 'END_TEMPLATE'
          # Runner: __BRANCH__

          [ðŸ‡»ðŸ‡³ Tiáº¿ng Viá»‡t](./README_VI.md)

          | Parameter | Value |
          |-----------|-------|
          | Version | __VERSION__ |
          | Scenario | __SCENARIO__ |
          | CPU | __CPU__ |
          | Memory | __MEMORY__ |
          | Workers | __WORKERS__ |

          ```bash
          docker compose up -d --build
          ```
          END_TEMPLATE

          cat > /tmp/readme_vi.template << 'END_TEMPLATE'
          # Runner: __BRANCH__

          [ðŸ‡ºðŸ‡¸ English](./README.md)

          | ThÃ´ng sá»‘ | GiÃ¡ trá»‹ |
          |----------|---------|
          | PhiÃªn báº£n | __VERSION__ |
          | Ká»‹ch báº£n | __SCENARIO__ |
          | CPU | __CPU__ |
          | Bá»™ nhá»› | __MEMORY__ |
          | Worker | __WORKERS__ |

          ```bash
          docker compose up -d --build
          ```
          END_TEMPLATE

          # Remove leading spaces from templates
          sed -i 's/^          //' /tmp/readme_en.template
          sed -i 's/^          //' /tmp/readme_vi.template

      - name: Sync to all branches
        run: |
          set -e

          SYNC_DOCKERFILE="${{ steps.changes.outputs.dockerfile }}"
          SYNC_COMPOSE="${{ steps.changes.outputs.compose }}"
          SYNC_CONFIG="${{ steps.changes.outputs.config }}"

          if [ "$SYNC_DOCKERFILE" = "false" ] && [ "$SYNC_COMPOSE" = "false" ] && [ "$SYNC_CONFIG" = "false" ]; then
            echo "No relevant changes, skipping"
            exit 0
          fi

          git checkout main && git pull origin main
          [ "$SYNC_DOCKERFILE" = "true" ] && cp Dockerfile /tmp/main_Dockerfile
          [ "$SYNC_COMPOSE" = "true" ] && cp docker-compose.yaml /tmp/main_docker_compose.yaml

          IP=$(yq '.ip' config.yaml | tr -d '"')
          CORES=$(yq '.runner | keys | .[]' config.yaml)

          generate_readme() {
            local BRANCH=$1 VERSION=$2 SCENARIO=$3 CPU=$4 MEMORY=$5 WORKERS=$6
            
            cp /tmp/readme_en.template README.md
            sed -i "s|__BRANCH__|$BRANCH|g; s|__VERSION__|$VERSION|g; s|__SCENARIO__|$SCENARIO|g; s|__CPU__|$CPU|g; s|__MEMORY__|$MEMORY|g; s|__WORKERS__|$WORKERS|g" README.md

            cp /tmp/readme_vi.template README_VI.md
            sed -i "s|__BRANCH__|$BRANCH|g; s|__VERSION__|$VERSION|g; s|__SCENARIO__|$SCENARIO|g; s|__CPU__|$CPU|g; s|__MEMORY__|$MEMORY|g; s|__WORKERS__|$WORKERS|g" README_VI.md
          }

          update_branch() {
            local BRANCH=$1 CPU=$2 MEMORY=$3 WORKERS=$4

            echo "Processing: $BRANCH (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"

            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              git branch -D "$BRANCH" 2>/dev/null || true
              git fetch origin "$BRANCH"
              git checkout -b "$BRANCH" "origin/$BRANCH"
            else
              git checkout main
              git checkout -b "$BRANCH"
            fi

            [ "$SYNC_DOCKERFILE" = "true" ] && [ -f /tmp/main_Dockerfile ] && cp /tmp/main_Dockerfile Dockerfile
            [ "$SYNC_COMPOSE" = "true" ] && [ -f /tmp/main_docker_compose.yaml ] && cp /tmp/main_docker_compose.yaml docker-compose.yaml

            sed -i "s|cpus: \"[^\"]*\"|cpus: \"$CPU\"|" docker-compose.yaml
            sed -i "s|memory: [^ ]*|memory: $MEMORY|" docker-compose.yaml
            sed -i "s|command: \[\"[^\"]*\", \"[^\"]*\"\]|command: [\"$IP\", \"$WORKERS\"]|" docker-compose.yaml

            VERSION=$(grep -oP 'ARG VERSION=\K[^\s]+' Dockerfile || echo "unknown")
            SCENARIO=$(grep -oP 'git clone -b \K[^\s]+' Dockerfile | head -1 || echo "unknown")

            generate_readme "$BRANCH" "$VERSION" "$SCENARIO" "$CPU" "$MEMORY" "$WORKERS"

            # Ensure .gitignore allows README files
            grep -q '!README\*.md' .gitignore 2>/dev/null || echo '!README*.md' >> .gitignore

            git add Dockerfile docker-compose.yaml README.md README_VI.md .gitignore
            if ! git diff --cached --quiet; then
              git commit -m "chore: Sync (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"
              git push origin "$BRANCH"
              echo "  âœ“ Pushed"
            else
              echo "  No changes"
            fi

            git checkout main
          }

          echo "=== Phase 1: Normal branches ==="
          for CORE in $CORES; do
            CPU=$(yq ".runner.$CORE.hw.cpu" config.yaml)
            MEMORY=$(yq ".runner.$CORE.hw.memory" config.yaml | tr -d '"')
            WORKERS=$(yq ".runner.$CORE.workers.normal" config.yaml)
            update_branch "$CORE" "$CPU" "$MEMORY" "$WORKERS"
          done

          echo "=== Phase 2: Derived branches ==="
          for CORE in $CORES; do
            CPU=$(yq ".runner.$CORE.hw.cpu" config.yaml)
            MEMORY=$(yq ".runner.$CORE.hw.memory" config.yaml | tr -d '"')
            
            for CLASS in $(yq ".runner.$CORE.workers | keys | .[]" config.yaml); do
              [ "$CLASS" = "normal" ] && continue
              WORKERS=$(yq ".runner.$CORE.workers.$CLASS" config.yaml)
              update_branch "$CORE-$CLASS" "$CPU" "$MEMORY" "$WORKERS"
            done
          done

          echo "âœ“ Done"
