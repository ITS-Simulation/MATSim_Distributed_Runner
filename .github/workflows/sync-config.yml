name: Sync Config to Branches

on:
  repository_dispatch:
    types: [version-update]
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-config.yml'
      - 'config.yaml'
      - 'docker-compose.yaml'
      - 'Dockerfile'

jobs:
  sync-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.MATSIM_RUNNER_PAT }}

      - name: Install yq
        uses: mikefarah/yq@v4.52.2

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect changed files
        id: changes
        run: |
          # Dispatch events always trigger a full sync
          if [ "${{ github.event_name }}" = "repository_dispatch" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Dispatch trigger - full sync"
            echo "dockerfile=true" >> $GITHUB_OUTPUT
            echo "compose=true" >> $GITHUB_OUTPUT
            echo "config=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          BEFORE="${{ github.event.before }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE" ]; then
            CHANGED="config.yaml docker-compose.yaml Dockerfile .github/workflows/sync-config.yml"
          else
            CHANGED=$(git diff --name-only "$BEFORE" HEAD 2>/dev/null || echo "config.yaml docker-compose.yaml Dockerfile")
          fi
          echo "files: $CHANGED"
          
          # If workflow file changed, do a full sync
          if echo "$CHANGED" | grep -q 'sync-config.yml'; then
            echo "Workflow file changed - triggering full sync"
            echo "dockerfile=true" >> $GITHUB_OUTPUT
            echo "compose=true" >> $GITHUB_OUTPUT
            echo "config=true" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=$(echo "$CHANGED" | grep -q 'Dockerfile' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "compose=$(echo "$CHANGED" | grep -q 'docker-compose.yaml' && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "config=$(echo "$CHANGED" | grep -q 'config.yaml' && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

      - name: Create README templates
        run: |
          cat > /tmp/readme_en.template << 'END_TEMPLATE'
          # Runner: __BRANCH__

          [ðŸ‡»ðŸ‡³ Tiáº¿ng Viá»‡t](./README_VI.md)

          | Parameter | Value |
          |-----------|-------|
          | Version | __VERSION__ |
          | Scenario | __SCENARIO__ |
          | CPU | __CPU__ |
          | Memory | __MEMORY__ |
          | Workers | __WORKERS__ |

          ```bash
          docker compose up -d --build
          ```
          END_TEMPLATE

          cat > /tmp/readme_vi.template << 'END_TEMPLATE'
          # Runner: __BRANCH__

          [ðŸ‡¬ðŸ‡§ English](./README.md)

          | ThÃ´ng sá»‘ | GiÃ¡ trá»‹ |
          |----------|---------|
          | PhiÃªn báº£n | __VERSION__ |
          | Ká»‹ch báº£n | __SCENARIO__ |
          | CPU | __CPU__ |
          | Bá»™ nhá»› | __MEMORY__ |
          | Worker | __WORKERS__ |

          ```bash
          docker compose up -d --build
          ```
          END_TEMPLATE

          # Remove leading spaces from templates
          sed -i 's/^          //' /tmp/readme_en.template
          sed -i 's/^          //' /tmp/readme_vi.template

      - name: Resolve MATSim version
        id: matsim
        run: |
          RUNNER_VER=$(sed -n 's/^ARG RUNNER_VER=\(.*\)$/\1/p' Dockerfile | tr -d ' \r' | head -1)
          RUNNER_VER=${RUNNER_VER:-latest}
          
          if [ "$RUNNER_VER" = "latest" ]; then
            RELEASE_JSON=$(curl -sfLH "Authorization: Bearer ${{ secrets.MATSIM_RUNNER_PAT }}" \
              https://api.github.com/repos/ITS-Simulation/MATSim_Custom/releases/latest)
            if [ $? -ne 0 ] || [ -z "$RELEASE_JSON" ]; then
              echo "::error::Failed to fetch MATSim release info from GitHub API"
              exit 1
            fi
            VERSION=$(echo "$RELEASE_JSON" | jq -r '.name // .tag_name // "latest"')
          else
            VERSION="$RUNNER_VER"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Sync to all branches
        run: |
          set -e

          SYNC_DOCKERFILE="${{ steps.changes.outputs.dockerfile }}"
          SYNC_COMPOSE="${{ steps.changes.outputs.compose }}"
          SYNC_CONFIG="${{ steps.changes.outputs.config }}"

          if [ "$SYNC_DOCKERFILE" = "false" ] && [ "$SYNC_COMPOSE" = "false" ] && [ "$SYNC_CONFIG" = "false" ]; then
            echo "No relevant changes, skipping"
            exit 0
          fi

          # --- Helpers ---
          require_val() {
            local name=$1 val=$2
            if [ -z "$val" ] || [ "$val" = "null" ]; then
              echo "::error::Missing required config value: $name"
              exit 1
            fi
          }

          git checkout main && git pull origin main
          [ "$SYNC_DOCKERFILE" = "true" ] && cp Dockerfile /tmp/main_Dockerfile
          [ "$SYNC_COMPOSE" = "true" ] && cp docker-compose.yaml /tmp/main_docker_compose.yaml

          IP=$(yq '.ip' config.yaml | tr -d '"')
          require_val "ip" "$IP"
          CORES=$(yq '.runner | keys | .[]' config.yaml)
          require_val "runner (no cores defined)" "$CORES"

          EXPECTED_BRANCHES=""

          generate_readme() {
            local BRANCH=$1 VERSION=$2 SCENARIO=$3 CPU=$4 MEMORY=$5 WORKERS=$6
            
            cp /tmp/readme_en.template README.md
            sed -i "s|__BRANCH__|$BRANCH|g; s|__VERSION__|$VERSION|g; s|__SCENARIO__|$SCENARIO|g; s|__CPU__|$CPU|g; s|__MEMORY__|$MEMORY|g; s|__WORKERS__|$WORKERS|g" README.md

            cp /tmp/readme_vi.template README_VI.md
            sed -i "s|__BRANCH__|$BRANCH|g; s|__VERSION__|$VERSION|g; s|__SCENARIO__|$SCENARIO|g; s|__CPU__|$CPU|g; s|__MEMORY__|$MEMORY|g; s|__WORKERS__|$WORKERS|g" README_VI.md
          }

          update_branch() {
            local BRANCH=$1 CPU=$2 MEMORY=$3 WORKERS=$4

            echo "Processing: $BRANCH (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"

            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              git branch -D "$BRANCH" 2>/dev/null || true
              git fetch origin "$BRANCH"
              git checkout -b "$BRANCH" "origin/$BRANCH"
            else
              git checkout main
              git checkout -b "$BRANCH"
            fi

            [ "$SYNC_DOCKERFILE" = "true" ] && [ -f /tmp/main_Dockerfile ] && cp /tmp/main_Dockerfile Dockerfile
            [ "$SYNC_COMPOSE" = "true" ] && [ -f /tmp/main_docker_compose.yaml ] && cp /tmp/main_docker_compose.yaml docker-compose.yaml

            sed -i "s|cpus: \"[^\"]*\"|cpus: \"$CPU\"|" docker-compose.yaml
            sed -i "s|memory: [^ ]*|memory: $MEMORY|" docker-compose.yaml
            sed -i "s|command: \[\"[^\"]*\", \"[^\"]*\"\]|command: [\"$IP\", \"$WORKERS\"]|" docker-compose.yaml

            VERSION="${{ steps.matsim.outputs.version }}"
            SCENARIO=$(sed -n 's|.*client-bro/git/refs/tags/\([^ ]*\).*|\1|p' Dockerfile | head -1)
            SCENARIO=${SCENARIO:-unknown}

            generate_readme "$BRANCH" "$VERSION" "$SCENARIO" "$CPU" "$MEMORY" "$WORKERS"
            
            git add -f Dockerfile docker-compose.yaml README.md README_VI.md
            if ! git diff --cached --quiet; then
              git commit -m "chore: Sync (CPU: $CPU, Mem: $MEMORY, Workers: $WORKERS)"
              git push origin "$BRANCH"
              echo "  âœ“ Pushed"
            else
              echo "  No changes"
            fi

            git checkout main
          }

          echo "=== Phase 1: Base branches ==="
          for CORE in $CORES; do
            CPU=$(yq ".runner[\"$CORE\"].hw.cpu" config.yaml)
            require_val "runner.$CORE.hw.cpu" "$CPU"
            MEMORY=$(yq ".runner[\"$CORE\"].hw.memory" config.yaml | tr -d '"')
            require_val "runner.$CORE.hw.memory" "$MEMORY"
            WORKERS=$(yq ".runner[\"$CORE\"].workers.normal" config.yaml)
            if [ "$WORKERS" = "null" ] || [ -z "$WORKERS" ]; then
              WORKERS=$(yq ".runner[\"$CORE\"].workers.base" config.yaml)
            fi
            if [ "$WORKERS" = "null" ] || [ -z "$WORKERS" ]; then
              echo "  âš  Skipping $CORE: no 'normal' or 'base' worker count defined"
              continue
            fi
            EXPECTED_BRANCHES="$EXPECTED_BRANCHES $CORE"
            update_branch "$CORE" "$CPU" "$MEMORY" "$WORKERS"
          done

          echo "=== Phase 2: Derived branches ==="
          for CORE in $CORES; do
            CPU=$(yq ".runner[\"$CORE\"].hw.cpu" config.yaml)
            MEMORY=$(yq ".runner[\"$CORE\"].hw.memory" config.yaml | tr -d '"')
            
            for CLASS in $(yq ".runner[\"$CORE\"].workers | keys | .[]" config.yaml); do
              [ "$CLASS" = "normal" ] || [ "$CLASS" = "base" ] && continue
              WORKERS=$(yq ".runner[\"$CORE\"].workers[\"$CLASS\"]" config.yaml)
              require_val "runner.$CORE.workers.$CLASS" "$WORKERS"
              EXPECTED_BRANCHES="$EXPECTED_BRANCHES $CORE-$CLASS"
              update_branch "$CORE-$CLASS" "$CPU" "$MEMORY" "$WORKERS"
            done
          done

          echo "=== Phase 3: Prune orphan branches ==="
          for REMOTE_BRANCH in $(git ls-remote --heads origin | awk '{print $2}' | sed 's|refs/heads/||' | grep -v '^main$'); do
            if ! echo "$EXPECTED_BRANCHES" | tr ' ' '\n' | grep -qxF "$REMOTE_BRANCH"; then
              echo "  Pruning orphan: $REMOTE_BRANCH"
              git push origin --delete "$REMOTE_BRANCH"
            fi
          done

          echo "âœ“ Done"
